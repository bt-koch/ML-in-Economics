---
output:
  pdf_document:
    number_sections: true
bibliography: tex/bibliography.bib
---

<!-- Setup -------------------------------------------------------------------->

```{r setup, include=FALSE}
if(!require(kableExtra)) install.packages("kableExtra")
if(!require(randomForest)) install.packages("randomForest")
if(!require(iml)) install.packages("iml")

library(kableExtra)
library(randomForest)
library(iml)

knitr::opts_chunk$set(echo = FALSE)

load("data/input.RData")
varnames <- list.export[["varnames"]]
```

<!-- Title Page + TOC --------------------------------------------------------->
\newpage
\vspace*{4cm}
\begin{center}
{\Large Machine Learning in Economics \\ (458657)}
\end{center}
\vspace*{1.5cm}
\begin{center}
\thispagestyle{empty}
{\LARGE \bf replication paper}\\[1.5cm]
{\Huge Early Warning System of Fiscal Stress}\\[1.5cm]
{\bf \Large comparing the traditional logistic regression approach versus a random forest algorithm}\\[2cm]
{\bf \large Department of Economics\\
University of Bern}\\[1cm]
{\Large Spring Semester 2022}\\[1.5cm]
{\large submitted by Bela Tim Koch} \\[2.5cm]
\end{center}

\newpage
\tableofcontents
\newpage

<!-- Report ------------------------------------------------------------------->


# Introduction

DEFINITION OF EWS. This paper aims to design an early warning system which signals
increased risk of a fiscal stress event in the near future.





test ob zitierung funktioniert @jarmulska2020.


# Literature Review

# Model Describtion

## Performance Metrics

## Logit Model with LASSO penalisation

@hastie2009

\begin{equation}
\hat{\beta}^{lasso} = \underset{\beta}{\text{argmin}} \sum^N_{i=1}(y_i - \beta_0 - \sum^p_{j=1}x_{ij}\beta_j)^2
\; \; \; \; \text{subject to} \; \; \; \sum^p_{j=1}|\beta_j| \leq t
\end{equation}

Lagrangian form

\begin{equation}
\hat{\beta}^{lasso} = \underset{\beta}{\text{argmin}} \left\{ \frac{1}{2} \sum^N_{i=1}(y_i - \beta_0 - \sum^p_{j=1}x_{ij}\beta_j)^2 + \lambda \sum^p_{j=1}|\beta_j| \right\}
\end{equation}

## Random Forest

Gini index

\begin{equation}
g(w) = \sum_{k \neq j}p_{wk}p_{wj} = \sum_k p_{wk}(1-p_{wk})
\end{equation}

# Data Describtion

## Dependent Variable

definition of a fiscal stress event

empirical/historical data about fiscal stress events

## Explanatory Variables

# Empirical Results

## Performance

```{r avg-pred-accur}
# get relevant data
dt <- list.export[["results.avg"]]

# manipulate formation
dt[!colnames(dt) %in% c("model", "auc")] <- apply(dt[!colnames(dt) %in% c("model", "auc")], 2, function(x) x*100)
dt[colnames(dt) != "model"] <- apply(dt[colnames(dt) != "model"], 2, function(x) round(x, 2))
```


\begin{table}[H]
\centering
\begin{tabular}{@{\extracolsep{4pt}}lrrrr@{}}
                                             & \multicolumn{2}{c}{Logit LASSO}                                         & \multicolumn{2}{c}{Random Forest}                                       \\ \cline{2-3} \cline{4-5}
                                             & \multicolumn{1}{c}{\begin{tabular}[c]{@{}r@{}}advanced\\ dummy\end{tabular}} & \multicolumn{1}{c}{\begin{tabular}[c]{@{}r@{}}GDP\\ per capita\end{tabular}} & \multicolumn{1}{c}{\begin{tabular}[c]{@{}r@{}}advanced\\ dummy\end{tabular}} & \multicolumn{1}{c}{\begin{tabular}[c]{@{}r@{}}GDP\\ per capita\end{tabular}} \\ \hline
\begin{tabular}[c]{@{}l@{}}\% of correctly\\ classified stress episodes\end{tabular}   & `r dt[dt$model == "logit.lasso.DUMMY",]$prop.pos` & `r dt[dt$model == "logit.lasso.GDP",]$prop.pos` & `r dt[dt$model == "rf.DUMMY",]$prop.pos` & `r dt[dt$model == "rf.GDP",]$prop.pos` \\ \hline
\begin{tabular}[c]{@{}l@{}}\% of correctly\\ classified tranquil episodes\end{tabular} & `r dt[dt$model == "logit.lasso.DUMMY",]$prop.neg` & `r dt[dt$model == "logit.lasso.GDP",]$prop.neg` & `r dt[dt$model == "rf.DUMMY",]$prop.neg` & `r dt[dt$model == "rf.GDP",]$prop.neg` \\ \hline
\begin{tabular}[c]{@{}l@{}}Average\\ \phantom{Average} \end{tabular}                                      & `r dt[dt$model == "logit.lasso.DUMMY",]$avg`      & `r dt[dt$model == "logit.lasso.GDP",]$avg`      & `r dt[dt$model == "rf.DUMMY",]$avg`      & `r dt[dt$model == "rf.GDP",]$avg`      \\ \hline
\begin{tabular}[c]{@{}l@{}}AUROC\\ \phantom{AUROC} \end{tabular}                                        & `r dt[dt$model == "logit.lasso.DUMMY",]$auc`      & `r dt[dt$model == "logit.lasso.GDP",]$auc`      & `r dt[dt$model == "rf.DUMMY",]$auc`      & `r dt[dt$model == "rf.GDP",]$auc`      \\ \hline
\end{tabular}
\caption{\label{tab:avg-pred-accur}Average prediction accuracy of early warning models for years 2009-2018 (all observations used)}
\end{table}


## Interpretability

### Variable Importance and Shapley Values

```{r rf.VI.SV, fig.cap="", fig.height=3}
# prepare data for plot for variable importance
rf.fit.eval <- list.export[["rf.fit.eval"]]

varimp <- as.data.frame(importance(rf.fit.eval))
varimp$variable <- rownames(varimp)
varimp <- varimp[order(varimp$MeanDecreaseGini, decreasing = T), c(1,2)]
varimp$yaxis <- rev(1:nrow(varimp))

varimp <- merge(x = varimp, y = varnames,
                by = "variable",
                all = T)

varimp <- varimp[order(varimp$MeanDecreaseGini, decreasing = T), c(1:4)]
labs.varimp <- rev(varimp$name)

# prepare data for plot for shapley values
shapley.values <- list.export[["shapley.values"]]

shapley.values <- shapley.values[order(shapley.values$x, decreasing = T), c(1,2)]
shapley.values$yaxis <- rev(1:nrow(shapley.values))

shapley.values <- merge(x = shapley.values, y = varnames,
                        by.x = "Group.1", by.y = "variable",
                        all = T)

shapley.values <- shapley.values[order(shapley.values$x, decreasing = T), c(1:4)]
labs.shapley <- rev(shapley.values$name)

# draw plot
par(mar = c(5.1, 10.5, 2.1, 0.5), mfrow = c(1,2), las=1, cex = 0.75, cex.axis = 0.75)

# plot 1: variable importance
plot(x = varimp$MeanDecreaseGini, y = varimp$yaxis,
     main = "", xlab = "Breiman's Variable Importance", ylab = "", yaxt = "none",
     pch = 16)
abline(h = 1:20, lty = 3)
axis(side = 2, at = 1:20, labels = labs.varimp)

# plot 2: shapley values
plot(x = shapley.values$x, y = shapley.values$yaxis,
     main = "", xlab = "Shapley Values", ylab = "", yaxt = "none", pch = 16)
abline(h = 1:20, lty = 3)
axis(side = 2, at = 1:20, labels = labs.shapley)
```


### Partial dependence plots and Accumulated local effects plots

```{r}

# prepare partial dependence plots
partial.ca_balance  <- list.export[["partial.ca_balance"]]
partial.net_lending <- list.export[["partial.net_lending"]]

p1 <- plot(x = partial.ca_balance$ca_balance, y = partial.ca_balance$yhat,
           type = "l", xlab = "Current account balance",
           ylab = "Predicted probability of stress")
p2 <- plot(x = partial.net_lending$net_lending, y = partial.net_lending$yhat,
           type = "l", xlab = "Net lending",
           ylab = "Predicted probability of stress")

par(mfrow = c(1,2))
p1
p2


```

# Conclusion

<!-- References --------------------------------------------------------------->
\newpage
# References
\bibliography{tex/bibliography.bib}